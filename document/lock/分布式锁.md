## 演示工程搭建

> 一个电商平台，该平台上有5000个商品，每个商品初始库存数量为1，总共有5000个用户在同一时刻下单购买商品，每个用户下单时会对所选商品库存数量进行一次减操作。如果最终所有商品的库存数量均为0，则表示所有商品已经售罄，如果有任何一个商品的库存数量大于0，则表示出现了并发问题（竞态条件问题（Race Condition）是指多个线程或进程在访问共享资源时，由于执行顺序不确定或者执行时间差异较大，导致最终的结果与执行顺序有关，出现了不确定性和不可预测性的情况。
>
> 竞态条件问题通常出现在并发编程中，例如多线程对同一个变量进行读写、多进程访问同一个文件等情况。为了更好地演示竞态条件问题，我们可以采用另一种方式来测试。
>
> 假设有5000个请求，我们将库存初始值设置为0，每个请求对库存进行一次加操作。如果最终库存数量为5000，则说明所有请求均已成功增加库存，没有出现并发问题。反之，如果最终库存数量小于5000，则说明出现了竞态条件问题。

![](https://oss.yiki.tech/img/202305030506707.png)

![](https://oss.yiki.tech/img/202305030506461.png)

![](https://oss.yiki.tech/img/202305030508529.png)

![](https://oss.yiki.tech/img/202305030510152.png)

### 并发问题解释

![](https://oss.yiki.tech/img/202305030546638.png)

### 测试本地锁存在的问题

#### 不加锁下的并发

> 可以发现并没有加到 5000值仅有 114。出现并发问题

![](https://oss.yiki.tech/img/202305030506461.png)

![](https://oss.yiki.tech/img/202305030517532.png)

![](https://oss.yiki.tech/img/202305030518711.png)

#### 添加本地锁的并发

> 添加 synchronized 本地锁, 将 number 值重置为 0 进行压测。得数是 5000 看似没有出现并发性问题，但是 本地锁只能在单个JVM内部生效，无法跨服务、跨工程、跨服务器实现协调和同步。

![](https://oss.yiki.tech/img/202305030556873.png)

![](https://oss.yiki.tech/img/202305030559362.png)

#### 测试集群下本地锁存在的问题

> copy 2 份实例模拟集群环境 将 number 设置为 0 重新压测 5000次。最终结果 2360 原因是极限情况下 3 台服务可能同时放入一个线程 同时到达 都将 num 转换为某一个数字 ++. 理论值在 5000 / 3 至 5000 间

![](https://oss.yiki.tech/img/202305030602517.png)

![](https://oss.yiki.tech/img/202305030604129.png)

![](https://oss.yiki.tech/img/202305030605651.png)

![](https://oss.yiki.tech/img/202305030607673.png)

![](https://oss.yiki.tech/img/202305030613114.png)